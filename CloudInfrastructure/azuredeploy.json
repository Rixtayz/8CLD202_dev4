{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "String",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "VaultName": {
      "type": "String",
      "metadata": {
        "description": "Key Vault Name"
      }
    },
    "AppConfigName": {
      "type": "String",
      "metadata": {
        "description": "AppConfigName Name"
      }
    },
    "ApplicationInsightName": {
      "type": "String",
      "metadata": {
        "description": "ApplicationInsight Name"
      }
    },
    "LogAnalyticsName": {
      "type": "String",
      "metadata": {
        "description": "LogAnalytics Name"
      }
    },
    "LocalDB": {
      "type": "securestring",
      "metadata": {
        "description": "Local Database connection string"
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "apiVersion": "2017-03-15-preview",
      "name": "[parameters('LogAnalyticsName')]",
      "location": "[resourceGroup().location]",
      "type": "Microsoft.OperationalInsights/workspaces",
      "properties": {
        "sku": {
          "name": "pergb2018"
        }
      }
    },
    {
      "name": "[parameters('ApplicationInsightName')]",
      "type": "microsoft.insights/components",
      "location": "[resourceGroup().location]",
      "apiVersion": "2020-02-02-preview",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsName'))]"
      ],
      "kind": "app",
      "properties": {
        "ApplicationId": "[parameters('ApplicationInsightName')]",
        "Application_Type": "web",
        "Flow_Type": "Bluefield",
        "Request_Source": "rest",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsName'))]"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-08-01-preview",
      "name": "[parameters('VaultName')]",
      "location": "[parameters('location')]",
      "dependsOn": [],
      "tags": {},
      "properties": {
        "enabledForDeployment": "true",
        "enabledForTemplateDeployment": "true",
        "enabledForDiskEncryption": "false",
        "enableRbacAuthorization": "true",
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "name": "Standard",
          "family": "A"
        },
        "publicNetworkAccess": "Enabled",
        "enableSoftDelete": "false",
        "networkAcls": {
          "value": {
            "defaultAction": "allow",
            "bypass": "AzureServices",
            "ipRules": [],
            "virtualNetworkRules": []
          }
        }
      }
    },
    {
      "type": "Microsoft.AppConfiguration/configurationStores",
      "apiVersion": "2023-03-01",
      "name": "[parameters('AppConfigName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "standard"
      },
      "properties": {
        "softDeleteRetentionInDays": "1",
        "enablePurgeProtection": "false",
        "disableLocalAuth": "false"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2021-11-01-preview",
      //semi hardcoded
      "name": "[format('{0}/{1}', parameters('VaultName'), 'ConnectionStringApplicationInsight')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('VaultName'))]",
        "[resourceId('Microsoft.Insights/components', parameters('ApplicationInsightName'))]"
      ],
      //This provide instrumentation key
      "properties": {
        "value": "[reference(resourceId('Microsoft.Insights/components', parameters('ApplicationInsightName')), '2020-02-02').ConnectionString]"
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2021-11-01-preview",
      //semi hardcoded
      "name": "[format('{0}/{1}', parameters('VaultName'), 'ConnectionStringAppConfig')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('VaultName'))]",
        "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('AppConfigName'))]"
      ],
      //This provide app config key
      "properties": {
        "value": "[listKeys(resourceId('Microsoft.AppConfiguration/configurationStores', parameters('AppConfigName')), '2023-03-01').value[2].connectionString]"
      } //application insight connection string, inside of App Config
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2024-04-01-preview",
      //semi hardcoded
      "name": "[concat(parameters('VaultName'), '/ConnectionStringLocalSQL')]",
      "location": "eastus",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('VaultName'))]",
        "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('AppConfigName'))]"
      ],
      //this provide local configuration for the DB of the web site.
      "properties": {
        "value": "[parameters('LocalDB')]",
        "attributes": {
          "enabled": true
        }
      }
    },
    //{
    //  "type": "Microsoft.AppConfiguration/configurationStores/keyValues",
    //  "apiVersion": "2024-05-01",
    //  // hardcoded
    //  "name": "[format('{0}/{1}', parameters('AppConfigName'), 'ConnectionStrings:ApplicationInsightTest')]",
    //  "dependsOn": [
    //    "[resourceId('Microsoft.KeyVault/vaults', parameters('VaultName'))]",
    //    "[resourceId('Microsoft.Insights/components', parameters('ApplicationInsightName'))]",
    //    "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('AppConfigName'))]"
    //  ],
    //  "properties": {
    //    "value": "[string(reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('VaultName'), 'ConnectionStringApplicationInsight'), '2019-09-01').secretUri)]",
    //    "contentType": "application/vnd.microsoft.appconfig.keyvaultref+json;charset=utf-8"
    //  }
    //},
    {
      "type": "Microsoft.AppConfiguration/configurationStores/keyValues",
      "apiVersion": "2024-05-01",
      // hardcoded
      "name": "[format('{0}/{1}', parameters('AppConfigName'), 'ConnectionStrings:LocalSQLTest')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('VaultName'))]",
        "[resourceId('Microsoft.Insights/components', parameters('ApplicationInsightName'))]",
        "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('AppConfigName'))]"
      ],
      "properties": {
        "value": "[string('https://gurokeyvault2.vault.azure.net/secrets/ConnectionStringLocalSQL/2ee57ee09ea047fb94b875b58f1a42c2')]",
        "contentType": "application/vnd.microsoft.appconfig.keyvaultref+json;charset=utf-8"
      }
    }
  ],
  "outputs": {
    "AppConfigName": {
      "type": "String",
      "value": "[parameters('AppConfigName')]"
    },
    // endpoint is not connectionstring .....
    "AppConfigEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.AppConfiguration/configurationStores', parameters('AppConfigName')), '2023-03-01').endpoint]"
    }
  }
}
